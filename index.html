<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orion API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <style>
        :root {
            --bg-dark: #050505;
            --bg-card: #0a0a0a;
            --border: #222222;
            --accent: #FFFC00;
            --text-main: #FFFFFF;
            --text-muted: #888888;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .sidebar-link {
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border-left-color: var(--accent);
        }

        .method-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 700;
        }
        .method-GET { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .method-POST { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }

        .code-block {
            font-family: 'JetBrains Mono', monospace;
            background: #111 !important;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            font-size: 0.85rem;
        }

        #login-overlay {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000000 100%);
        }
        
        /* Tester Modal Styles */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        .input-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: bold;
            color: #888;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        .tester-input {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            padding: 0.5rem;
            border-radius: 0.5rem;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .tester-input:focus { border-color: var(--accent); }

        /* Custom Select Styles */
        .custom-select-trigger {
            background: #111;
            border: 1px solid #333;
            padding: 0.75rem;
            border-radius: 0.5rem;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            user-select: none;
        }
        .custom-select-trigger:hover { border-color: #555; }
        
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #111;
            border: 1px solid #333;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        
        .custom-select.open .custom-select-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .custom-select.open .custom-select-trigger {
            border-bottom-color: #111;
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .custom-option {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.1s;
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .custom-option:last-child { border-bottom: none; }
        .custom-option:hover { background: #1a1a1a; }
        .custom-option.selected { background: #222; }
        
        .custom-optgroup-label {
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
            background: #0d0d0d;
            position: sticky;
            top: 0;
        }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden relative">

    <!-- TESTER BUTTON (Hidden by default) -->
    <div id="tester-trigger" class="hidden absolute top-6 right-6 z-50">
        <button onclick="tester.open()" class="bg-[#1a1a1a] hover:bg-[#222] border border-[#333] hover:border-[#FFFC00] text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all shadow-lg font-bold text-sm">
            <i class="fa-solid fa-flask text-[#FFFC00]"></i>
            Test API
        </button>
    </div>

    <!-- API TESTER MODAL -->
    <div id="tester-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-[#0a0a0a] border border-[#222] w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] fade-in">
            
            <!-- Header -->
            <div class="p-4 border-b border-[#222] flex justify-between items-center bg-[#111] rounded-t-2xl">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-flask text-[#FFFC00]"></i> API Tester
                </h3>
                <button onclick="tester.close()" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <!-- Body -->
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                
                <!-- Settings: API URL and Steam ID Header -->
                <div class="bg-[#111] p-3 rounded-lg border border-[#333] mb-2 space-y-3">
                    <div class="input-group">
                        <label>API Base URL</label>
                        <input type="text" id="tester-base-url" class="tester-input font-mono text-blue-400 border-[#333] focus:border-blue-500" placeholder="e.g., http://localhost:8000">
                    </div>
                    <div class="input-group">
                        <label>Simulated Steam ID (Header)</label>
                        <input type="text" id="tester-header-steamid" class="tester-input font-mono text-[#FFFC00] border-[#333] focus:border-[#FFFC00]" value="76561198012345678">
                    </div>
                </div>

                <!-- Endpoint Selector -->
                <div class="relative">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Select Endpoint</label>
                    
                    <!-- Custom Select DOM -->
                    <div id="custom-select" class="custom-select relative w-full">
                        <div class="custom-select-trigger" onclick="this.parentElement.classList.toggle('open')">
                            <span id="custom-select-value" class="text-gray-400">-- Choose an endpoint --</span>
                            <i class="fa-solid fa-chevron-down text-gray-500 text-xs"></i>
                        </div>
                        <div class="custom-select-options custom-scrollbar" id="custom-select-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Dynamic Params -->
                <div id="tester-params-container" class="hidden space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="h-px bg-[#222] flex-1"></div>
                        <span class="text-xs font-bold text-gray-500 uppercase">Parameters</span>
                        <div class="h-px bg-[#222] flex-1"></div>
                    </div>
                    <div id="tester-inputs-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Inputs injected here -->
                    </div>
                </div>

                <!-- Info Box -->
                <div id="tester-info" class="bg-[#111] border border-[#222] p-4 rounded-lg text-center text-gray-500 text-sm">
                    Select an endpoint above to begin testing.
                </div>

            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-[#222] bg-[#111] rounded-b-2xl flex justify-between items-center">
                <button onclick="tester.generateData()" id="btn-gen-data" class="hidden text-gray-400 hover:text-[#FFFC00] text-sm font-bold flex items-center gap-2 transition">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Generate Data
                </button>
                <div class="flex gap-3 ml-auto">
                    <button onclick="tester.close()" class="px-4 py-2 text-gray-400 hover:text-white font-bold text-sm">Cancel</button>
                    <button onclick="tester.send()" id="btn-send-req" disabled class="bg-[#FFFC00] hover:bg-[#e6e300] text-black px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>Send Request</span>
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- RESPONSE MODAL -->
    <div id="response-modal" class="hidden fixed inset-0 z-[70] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-[#0a0a0a] border border-[#222] w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[85vh] fade-in transform scale-100 transition-all">
            <div id="response-header" class="p-4 border-b border-[#222] flex justify-between items-center rounded-t-2xl bg-[#111]">
                <h3 class="font-bold text-lg flex items-center gap-2" id="response-title">
                    <!-- Title injected -->
                </h3>
                <button onclick="tester.closeResponse()" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-0 overflow-hidden flex-1 relative bg-[#050505]">
                <pre class="w-full h-full p-4 overflow-auto text-xs font-mono language-json" style="margin:0;"><code id="response-code"></code></pre>
            </div>
            <div class="p-4 border-t border-[#222] bg-[#111] rounded-b-2xl flex justify-end">
                <button onclick="tester.closeResponse()" class="bg-[#222] hover:bg-[#333] text-white px-6 py-2 rounded-lg font-bold text-sm transition">
                    Back to Tester
                </button>
            </div>
        </div>
    </div>


    <div id="login-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4">
        
        <div id="step-github" class="max-w-md w-full bg-[#0a0a0a] border border-[#222] p-8 rounded-3xl shadow-2xl text-center fade-in">
            <div class="w-20 h-20 bg-[#111] rounded-full flex items-center justify-center mx-auto mb-6 border border-[#222]">
                <i class="fa-solid fa-book-journal-whills text-4xl text-[#FFFC00]"></i>
            </div>
            <h1 class="text-3xl font-black mb-2">Orion API</h1>
            <p class="text-gray-500 mb-8 text-sm">Restricted Documentation Access</p>
            
            <button onclick="auth.loginGithub()" class="w-full bg-[#24292e] hover:bg-[#2f363d] text-white font-bold py-4 rounded-xl flex items-center justify-center gap-3 transition-all transform hover:scale-[1.02]">
                <i class="fa-brands fa-github text-2xl"></i>
                <span>Login with GitHub</span>
            </button>
            <p class="mt-4 text-xs text-gray-600">Authentication required via GitHub OAuth</p>
        </div>

        <div id="step-decoy" class="hidden w-full h-full flex flex-col items-center justify-center fade-in">
            <div class="text-center">
                <h1 class="text-9xl font-black text-[#222] select-none">404</h1>
                <h2 class="text-2xl font-bold text-white mt-4 select-none">Page Not Found</h2>
                <p class="text-gray-500 mt-2 select-none">The requested resource could not be located on this server.</p>
                <div class="mt-8">
                     <button onclick="location.href = location.href.split('?')[0]" class="px-6 py-2 bg-[#111] border border-[#222] rounded-lg text-sm text-gray-400 hover:text-white hover:border-white transition">Go Home</button>
                </div>
            </div>
        </div>

    </div>

    <aside class="w-full md:w-80 bg-[#0a0a0a] border-r border-[#222] flex flex-col h-full z-10">
        <div class="p-6 border-b border-[#222]">
            <h1 class="text-2xl font-black tracking-tight flex items-center gap-2">
                <span class="text-[#FFFC00]">Orion</span> API
            </h1>
            <div class="mt-4 relative">
                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-600 text-xs"></i>
                <input type="text" id="search-input" placeholder="Search endpoints..." class="w-full bg-[#111] border border-[#222] rounded-lg py-2 pl-9 pr-4 text-sm text-white focus:outline-none focus:border-[#FFFC00] transition-colors placeholder-gray-600">
            </div>
        </div>
        <nav id="sidebar-nav" class="flex-1 overflow-y-auto p-2 space-y-1">
        </nav>
        <div class="p-4 border-t border-[#222] text-center">
            <p class="text-xs text-gray-600 font-mono">v1.0.2 &bull; <a href="#" onclick="auth.logout()" class="text-red-500 hover:text-red-400">Logout</a></p>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#050505] relative scroll-smooth" id="main-content">
        <div class="max-w-4xl mx-auto p-8 md:p-12 space-y-16">
            
            <section class="space-y-4 border-b border-[#222] pb-8">
                <h2 class="text-4xl font-black text-white">Introduction</h2>
                <p class="text-gray-400 leading-relaxed">
                    Welcome to the Orion Game Server API. All endpoints are prefixed with <code class="bg-[#111] border border-[#222] px-1 py-0.5 rounded text-[#FFFC00] text-sm">/api/v1/command</code>.
                    Authentication is handled via the <code class="text-blue-400">x-steam-id</code> header or session cookies depending on context.
                </p>
            </section>

            <div id="endpoints-container" class="space-y-16">
            </div>

            <footer class="pt-20 pb-10 text-center text-gray-600 text-sm">
                &copy; 2025 Orion Labs. All rights reserved.
            </footer>
        </div>
    </main>

    <script>
        // Removed hardcoded const API_BASE_URL

        const apiData = [
            {
                category: "Player Management",
                items: [
                    {
                        title: "Retrieve Players List",
                        method: "GET",
                        route: "/players/list",
                        desc: "Retrieves a list of all currently connected players.",
                        response: {
                            type: "player_list",
                            count: 2,
                            players: [
                                { PlayerName: "DinoSlayer", SteamID: "765611980...", Location: "X: -1500, Y: 3000, Z: 500", IsDevOrAdmin: "Admin" },
                                { PlayerName: "RaptorBlue", SteamID: "765611981...", Location: "X: 4500, Y: 100, Z: 0", IsDevOrAdmin: "None" }
                            ]
                        }
                    },
                    {
                        title: "Retrieve Player Info",
                        method: "GET",
                        route: "/player/:steamId",
                        desc: "Get detailed vitals and stats for a specific player.",
                        response: {
                            steamId: "765611980...",
                            PlayerName: "DinoSlayer",
                            dinoType: "Tyrannosaurus",
                            growth: 0.75,
                            health: 85.5,
                            location: { x: -1500, y: 3000, z: 500 },
                            nest: { code: "A1B2", eggCount: 3 }
                        }
                    }
                ]
            },
            {
                category: "Dino Actions",
                items: [
                    {
                        title: "Slay Dino",
                        method: "POST",
                        route: "/slay/:steamId",
                        desc: "Instantly kills the player's character.",
                        response: { type: "SLAY_DINO_successful", status: "Success" }
                    },
                    {
                        title: "Heal Dino",
                        method: "POST",
                        route: "/heal/:steamId",
                        desc: "Restores health, hunger, thirst, and stamina to 100%.",
                        response: { type: "HEAL_DINO_successful", status: "Success" }
                    },
                    {
                        title: "Grow Dino",
                        method: "POST",
                        route: "/grow/:steamId/:percent",
                        desc: "Sets growth percentage (0.0 to 1.0).",
                        response: { type: "GROW_DINO_successful", status: "Success", reason: "Set to 1.0" }
                    },
                    {
                        title: "Set Custom Dino",
                        method: "POST",
                        route: "/set-custom-dino/:steamId/:class",
                        desc: "Forces a class change (e.g. BP_Rex_C).",
                        response: { type: "SET_CUSTOM_DINO_successful", status: "Success" }
                    }
                ]
            },
            {
                category: "Stats",
                items: [
                    {
                        title: "Set Vitals",
                        method: "POST",
                        route: "/set-[stat]/:steamId/:value",
                        desc: "Generic endpoint for set-health, set-hunger, set-thirst, set-stamina.",
                        response: { type: "SET_HEALTH_successful", status: "Success" }
                    }
                ]
            },
            {
                category: "Teleportation",
                items: [
                    {
                        title: "Teleport to Player",
                        method: "POST",
                        route: "/teleport-to-player/:steamId/:targetId",
                        desc: "Teleports source player to target player.",
                        response: { type: "TELEPORT_TO_PLAYER_successful", status: "Success" }
                    },
                    {
                        title: "Teleport to Coords",
                        method: "POST",
                        route: "/teleport-to-coords/:steamId/:x/:y/:z",
                        desc: "Teleports player to specific coordinates.",
                        response: { type: "TELEPORT_TO_COORDS_successful", status: "Success" }
                    }
                ]
            },
            {
                category: "Communication",
                items: [
                    {
                        title: "Send Message",
                        method: "POST",
                        route: "/message/send",
                        desc: "Sends a chat message or announcement.",
                        payload: {
                            messageType: "Chat",
                            text: "Server restart in 5m",
                            chatType: "Global",
                            senderName: "Admin"
                        },
                        response: { type: "SEND_MESSAGE_successful", status: "Sent" }
                    },
                    {
                        title: "Send Notification",
                        method: "POST",
                        route: "/notification/send",
                        desc: "Sends a UI popup notification to a specific player.",
                        payload: {
                            text: "You have been healed!",
                            targetId: "765611980..."
                        },
                        response: { type: "SEND_NOTIFICATION_successful", status: "Sent" }
                    }
                ]
            },
            {
                category: "Configuration",
                items: [
                    {
                        title: "Update Config",
                        method: "POST",
                        route: "/config/update",
                        desc: "Updates server settings dynamically.",
                        payload: { ConfigServerName: "Orion Server", ConfigMaxPlayers: 100 },
                        response: { type: "UPDATE_CONFIG_successful", status: "Updated" }
                    },
                    {
                        title: "Get Config",
                        method: "POST",
                        route: "/config/get",
                        desc: "Retrieves current server configuration.",
                        response: { type: "config_data", gameSession: [], gameState: [] }
                    }
                ]
            }
        ];

        const auth = {
            clientId: 'Ov23li9jHMqW9mz8Q8LX',
            buffer: "",
            timer: null,
            
            init: () => {
                const overlay = document.getElementById('login-overlay');
                const stepGithub = document.getElementById('step-github');
                const stepDecoy = document.getElementById('step-decoy');
                const params = new URLSearchParams(window.location.search);

                if (localStorage.getItem('orion_docs_status') === 'unlocked') {
                    overlay.classList.add('hidden');
                    document.getElementById('tester-trigger').classList.remove('hidden');
                    return;
                }

                const code = params.get('code');
                if (code) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                    stepGithub.classList.add('hidden');
                    stepDecoy.classList.remove('hidden');
                    auth.startSecretListener();
                }
            },
            
            loginGithub: () => {
                const redirectUri = window.location.href.split('?')[0]; 
                window.location.href = `https://github.com/login/oauth/authorize?client_id=${auth.clientId}&redirect_uri=${redirectUri}&scope=read:user`;
            },

            startSecretListener: () => {
                auth.timer = setTimeout(auth.checkTime, 10000);
                document.addEventListener('keydown', auth.handleKey);
            },

            checkTime: () => {
                if (auth.buffer.toUpperCase().startsWith("RAT")) {
                    auth.timer = setTimeout(() => {
                        location.reload(); 
                    }, 10000);
                } else {
                    location.reload();
                }
            },

            handleKey: (e) => {
                if (e.key === 'Enter') {
                    if (auth.buffer.toUpperCase() === 'RATS') {
                        clearTimeout(auth.timer); 
                        localStorage.setItem('orion_docs_status', 'unlocked');
                        const overlay = document.getElementById('login-overlay');
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.classList.add('hidden'), 500);
                        document.getElementById('tester-trigger').classList.remove('hidden');
                    } else {
                        location.reload();
                    }
                } else if (e.key.length === 1) {
                    auth.buffer += e.key;
                }
            },

            logout: () => {
                localStorage.removeItem('orion_docs_status');
                location.reload();
            }
        };

        // --- TESTER LOGIC ---
        const tester = {
            currentEndpoint: null,
            
            init: () => {
                // Initialize Custom Select Dropdown
                const list = document.getElementById('custom-select-list');
                const triggerVal = document.getElementById('custom-select-value');
                const selectContainer = document.getElementById('custom-select');
                let idx = 0;

                // Close on outside click
                document.addEventListener('click', (e) => {
                    if (!selectContainer.contains(e.target)) selectContainer.classList.remove('open');
                });

                apiData.forEach(cat => {
                    // Optgroup Header
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'custom-optgroup-label';
                    groupHeader.textContent = cat.category;
                    list.appendChild(groupHeader);

                    cat.items.forEach(item => {
                        const opt = document.createElement('div');
                        opt.className = 'custom-option';
                        opt.innerHTML = `
                            <span class="method-badge ${item.method === 'GET' ? 'method-GET' : 'method-POST'}">${item.method}</span>
                            <span class="text-sm font-medium text-gray-300">${item.title}</span>
                        `;
                        
                        opt.onclick = () => {
                            triggerVal.innerHTML = `
                                <span class="method-badge ${item.method === 'GET' ? 'method-GET' : 'method-POST'} mr-2">${item.method}</span>
                                ${item.title}
                            `;
                            triggerVal.className = "text-white flex items-center";
                            selectContainer.classList.remove('open');
                            tester.selectEndpoint(item._flatIndex);
                        };

                        list.appendChild(opt);
                        item._flatIndex = idx;
                        idx++;
                    });
                });
            },

            open: () => {
                document.getElementById('tester-modal').classList.remove('hidden');
                // Generate random default steam ID if empty
                if(!document.getElementById('tester-header-steamid').value) {
                    document.getElementById('tester-header-steamid').value = "7656119" + Math.floor(Math.random() * 10000000000);
                }
                
                // Initialize base URL from local storage if available
                const storedBaseUrl = localStorage.getItem('orion_tester_url');
                if (storedBaseUrl) {
                    document.getElementById('tester-base-url').value = storedBaseUrl;
                }
            },

            close: () => {
                document.getElementById('tester-modal').classList.add('hidden');
            },

            getFlatItem: (index) => {
                let found = null;
                apiData.forEach(cat => {
                    cat.items.forEach(item => {
                        if (item._flatIndex == index) found = item;
                    });
                });
                return found;
            },

            selectEndpoint: (index) => {
                const container = document.getElementById('tester-params-container');
                const grid = document.getElementById('tester-inputs-grid');
                const info = document.getElementById('tester-info');
                const btnSend = document.getElementById('btn-send-req');
                const btnGen = document.getElementById('btn-gen-data');

                const item = tester.getFlatItem(index);
                if (!item) return;

                tester.currentEndpoint = item;
                
                info.classList.add('hidden');
                container.classList.remove('hidden');
                btnSend.disabled = false;
                btnGen.classList.remove('hidden');
                grid.innerHTML = '';

                // Extract URL Params (:param)
                const urlParams = item.route.match(/:[a-zA-Z]+/g) || [];
                urlParams.forEach(p => {
                    const name = p.substring(1);
                    tester.createInput(grid, name, 'URL Parameter');
                });

                // Body Params
                if (item.payload) {
                    Object.keys(item.payload).forEach(key => {
                        tester.createInput(grid, key, 'Body Parameter');
                    });
                } else if (urlParams.length === 0) {
                     grid.innerHTML = '<div class="col-span-full text-center text-gray-600 text-sm italic py-2">No parameters required.</div>';
                }
            },

            createInput: (container, name, type) => {
                const div = document.createElement('div');
                div.className = 'input-group';
                div.innerHTML = `
                    <label>${name} <span class="text-[10px] bg-[#222] px-1 rounded ml-1 text-gray-500">${type}</span></label>
                    <input type="text" class="tester-input" data-key="${name}" placeholder="...">
                `;
                container.appendChild(div);
            },

            generateData: () => {
                const inputs = document.querySelectorAll('.tester-input');
                inputs.forEach(input => {
                    if(input.id === 'tester-header-steamid' || input.id === 'tester-base-url') return; // Don't regen auth header or url

                    const k = input.getAttribute('data-key').toLowerCase();
                    let val = "TestValue";
                    
                    if (k.includes('steamid') || k.includes('id')) val = "7656119" + Math.floor(Math.random() * 10000000000);
                    else if (k.includes('amount') || k.includes('count') || k.includes('value')) val = Math.floor(Math.random() * 100);
                    else if (k.includes('percent')) val = "1.0";
                    else if (k.includes('coord') || k === 'x' || k === 'y' || k === 'z') val = Math.floor(Math.random() * 10000);
                    else if (k.includes('class')) val = "BP_Rex_C";
                    else if (k.includes('name')) val = "OrionTester";
                    
                    input.value = val;
                });
            },

            send: async () => {
                const item = tester.currentEndpoint;
                if (!item) return;

                const headerSteamId = document.getElementById('tester-header-steamid').value.trim();
                const baseUrl = document.getElementById('tester-base-url').value.trim().replace(/\/$/, ''); // Trim trailing slash

                if(!headerSteamId) {
                    alert("Simulated Steam ID (Header) is required for server authentication.");
                    return;
                }
                
                if(!baseUrl) {
                    alert("Please enter a valid API Base URL.");
                    return;
                }
                
                // Save base URL preference
                localStorage.setItem('orion_tester_url', baseUrl);

                // Build Route
                let finalPath = '/api/v1/command' + item.route;
                const body = {};
                const inputs = document.querySelectorAll('.tester-input');
                
                inputs.forEach(input => {
                    if(input.id === 'tester-header-steamid' || input.id === 'tester-base-url') return;

                    const key = input.getAttribute('data-key');
                    const val = input.value.trim();
                    
                    if (finalPath.includes(`:${key}`)) {
                        finalPath = finalPath.replace(`:${key}`, val);
                    } else {
                        // Body param logic
                        if (val === 'true') body[key] = true;
                        else if (val === 'false') body[key] = false;
                        else if (!isNaN(val) && val !== '') body[key] = Number(val);
                        else body[key] = val;
                    }
                });

                // UI Loading State
                const btn = document.getElementById('btn-send-req');
                const icon = btn.querySelector('i');
                const origIcon = icon.className;
                
                btn.disabled = true;
                icon.className = "fa-solid fa-circle-notch fa-spin";

                const fullUrl = baseUrl + finalPath;

                try {
                    const options = {
                        method: item.method,
                        headers: {
                            'Content-Type': 'application/json',
                            'x-steam-id': headerSteamId
                        }
                    };

                    if (item.method !== 'GET') {
                        options.body = JSON.stringify(body);
                    }

                    const res = await fetch(fullUrl, options);
                    
                    let data;
                    const text = await res.text();
                    try {
                        data = JSON.parse(text);
                    } catch {
                        data = { raw: text };
                    }

                    tester.showResponse(res.ok, res.status, data);

                } catch (e) {
                    // Detect Mixed Content / CORS Errors generally result in TypeError with no status
                    let errorDetails = e.message;
                    let hint = "Ensure server is running at " + baseUrl;

                    if (window.location.protocol === 'https:' && baseUrl.startsWith('http:')) {
                        errorDetails = "Mixed Content Error (Blocked by Browser)";
                        hint = "You are trying to access a non-secure (HTTP) API from a secure (HTTPS) site. <br>Browsers block this for security. <br><b>Solution:</b> Use localhost for both, or enable SSL on your API.";
                    } else if (e.name === 'TypeError' && e.message === 'Failed to fetch') {
                        errorDetails = "CORS Policy Block or Network Error";
                        hint = "The server at " + baseUrl + " did not accept the request.<br>1. Check if the server is running.<br>2. Ensure the server sends 'Access-Control-Allow-Origin: *' headers.<br>3. Check if your browser is blocking local requests.";
                    }

                    tester.showResponse(false, 0, { 
                        error: "Request Failed", 
                        details: errorDetails,
                        hint: hint
                    });
                } finally {
                    btn.disabled = false;
                    icon.className = origIcon;
                }
            },

            showResponse: (success, status, data) => {
                const modal = document.getElementById('response-modal');
                const header = document.getElementById('response-header');
                const title = document.getElementById('response-title');
                const code = document.getElementById('response-code');

                modal.classList.remove('hidden');
                
                // Color Logic
                if (success) {
                    header.className = "p-4 border-b border-[#222] flex justify-between items-center rounded-t-2xl bg-green-900/20 border-green-500/30";
                    title.className = "font-bold text-lg flex items-center gap-2 text-green-400";
                    title.innerHTML = `<i class="fa-solid fa-check-circle"></i> Success (${status})`;
                } else {
                    header.className = "p-4 border-b border-[#222] flex justify-between items-center rounded-t-2xl bg-red-900/20 border-red-500/30";
                    title.className = "font-bold text-lg flex items-center gap-2 text-red-400";
                    title.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Error (${status})`;
                }

                code.innerHTML = JSON.stringify(data, null, 2); // Use innerHTML to allow basic tags in hints
                Prism.highlightElement(code);
            },

            closeResponse: () => {
                document.getElementById('response-modal').classList.add('hidden');
            }
        };

        const renderer = {
            init: () => {
                const nav = document.getElementById('sidebar-nav');
                const container = document.getElementById('endpoints-container');
                
                let navHtml = '';
                let mainHtml = '';

                apiData.forEach((cat, catIndex) => {
                    navHtml += `<div class="px-3 pt-5 pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider">${cat.category}</div>`;
                    
                    cat.items.forEach((item, itemIndex) => {
                        const id = `ep-${catIndex}-${itemIndex}`;
                        
                        navHtml += `
                            <a href="#${id}" class="sidebar-link block px-3 py-2 text-sm text-gray-400 rounded-r-lg">
                                <span class="mr-2 text-[10px] uppercase font-bold ${item.method === 'GET' ? 'text-blue-400' : 'text-green-400'}">${item.method}</span>
                                ${item.title}
                            </a>`;

                        mainHtml += `
                            <section id="${id}" class="scroll-mt-24 endpoint-card">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="text-2xl font-bold text-white mb-2">${item.title}</h3>
                                        <div class="flex items-center gap-3">
                                            <span class="method-badge ${item.method === 'GET' ? 'method-GET' : 'method-POST'}">${item.method}</span>
                                            <code class="text-sm text-gray-400 font-mono bg-[#111] px-2 py-1 rounded border border-[#222]">${item.route}</code>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-gray-400 mb-6 text-sm leading-relaxed border-l-2 border-[#333] pl-4">${item.desc}</p>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    ${item.payload ? `
                                    <div>
                                        <p class="text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Payload Body</p>
                                        <pre class="code-block"><code class="language-json">${JSON.stringify(item.payload, null, 2)}</code></pre>
                                    </div>` : ''}
                                    
                                    <div class="${!item.payload ? 'col-span-full' : ''}">
                                        <p class="text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Response Example</p>
                                        <pre class="code-block"><code class="language-json">${JSON.stringify(item.response, null, 2)}</code></pre>
                                    </div>
                                </div>
                            </section>
                        `;
                    });
                });

                nav.innerHTML = navHtml;
                container.innerHTML = mainHtml;
                
                Prism.highlightAll();
            },

            filter: (term) => {
                const termLower = term.toLowerCase();
                const cards = document.querySelectorAll('.endpoint-card');
                const links = document.querySelectorAll('.sidebar-link');
                
                cards.forEach((card, idx) => {
                    const text = card.innerText.toLowerCase();
                    const visible = text.includes(termLower);
                    
                    card.style.display = visible ? 'block' : 'none';
                    if (links[idx]) links[idx].style.display = visible ? 'block' : 'none';
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            auth.init();
            renderer.init();
            tester.init(); // Init tester

            document.getElementById('search-input').addEventListener('input', (e) => {
                renderer.filter(e.target.value);
            });
        });

    </script>
</body>
</html>
